on:
  push:
    tags:
      - "v*"

jobs:

  build-and-upload:
    name: build and upload
    strategy:
      matrix:
        os: [macos, ubuntu, windows]
        include:
          - os: ubuntu
            artifact-name: main/deb/kotlin-bars_*_amd64.deb
            asset-name: kotlin-bars-desktop-amd64.deb
            app-distributable: main/app/Kotlin\ Bars/bin/Kotlin\ Bars
            app-name: kotlin-bars-desktop-linux-amd64
          - os: macos
            artifact-name: main/dmg/Kotlin\ Bars-*.dmg
            asset-name: kotlin-bars-desktop-amd64.dmg
            app-distributable: main/app/Kotlin\ Bars.app/Contents/MacOS/Kotlin\ Bars
            app-name: kotlin-bars-desktop-macos-amd64
          - os: windows
            artifact-name: main/msi/Kotlin\ Bars-*.msi
            asset-name: kotlin-bars-desktop-amd64.msi
            app-distributable: main/app/Kotlin\ Bars/bin/Kotlin\ Bars.exe
            app-name: kotlin-bars-desktop-windows-amd64
    runs-on: ${{ matrix.os }}-latest

    steps:
      - name: checkout
        uses: actions/checkout@v2

      - name: setup java
        uses: actions/setup-java@v2
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: build ${{ matrix.os }} package
        env:
          REF: ${{ github.ref }}
        run: |
          ./gradlew :desktop:package -PbarsUrl=https://${{ secrets.DOMAINS }}/api/bars
          ./gradlew :desktop:createDistributable -PbarsUrl=https://${{ secrets.DOMAINS }}/api/bars
          mv desktop/build/compose/binaries/${{ matrix.artifact-name }} desktop/build/compose/binaries/${{ matrix.asset-name }}
          mv desktop/build/compose/binaries/${{ matrix.app-distributable }} desktop/build/compose/binaries/${{ matrix.app-name }}

      - name: upload ${{ matrix.os }} package
        uses: actions/upload-artifact@v2
        with:
          name: ${{ matrix.asset-name }}
          path: desktop/build/compose/binaries/${{ matrix.asset-name }}

      - name: upload ${{ matrix.os }} app
        uses: actions/upload-artifact@v2
        with:
          name: ${{ matrix.app-name }}
          path: desktop/build/compose/binaries/${{ matrix.app-name }}

      - name: release ${{ matrix.os }} package
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: desktop/build/compose/binaries/${{ matrix.asset-name }}
          overwrite: true
          tag: ${{ github.ref }}

      - name: release ${{ matrix.os }} package
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: desktop/build/compose/binaries/${{ matrix.app-name }}
          overwrite: true
          tag: ${{ github.ref }}
